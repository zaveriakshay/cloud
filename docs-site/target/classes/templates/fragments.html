<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

<!-- ===================================================================================== -->
<!-- UNIFIED SITE HEADER                                                                   -->
<!-- ===================================================================================== -->
<header th:fragment="header_main" class="bg-white/95 backdrop-blur-sm sticky top-0 z-40 border-b border-slate-200">
    <!-- First line: Logo, Search, Auth -->
    <div class="px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <!-- Left: Logo -->
            <div class="flex-shrink-0">
                <a th:href="@{/}" class="flex items-center gap-2">
                    <span class="text-xl font-bold text-indigo-600">noqodiDocs</span>
                </a>
            </div>

            <!-- Center: Search Modal Trigger -->
            <div class="flex-1 flex justify-center px-8 lg:px-16">
                <button @click.prevent="openSearchModal()" type="button" class="w-full max-w-lg relative text-left">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>
                    </div>
                    <div class="block w-full rounded-md border-slate-300 bg-slate-50 py-2 pl-10 pr-20 text-sm shadow-sm text-slate-500">
                        Search documentation...
                    </div>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <kbd class="font-sans text-xs font-medium text-slate-400 border border-slate-300 rounded px-1.5 py-0.5">âŒ˜K</kbd>
                    </div>
                </button>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-4">
                <button @click="aiPanelOpen = !aiPanelOpen" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors" aria-label="Ask AI">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.178-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.178a2.25 2.25 0 001.423 1.423l1.178.398-1.178.398a2.25 2.25 0 00-1.423 1.423z" />
                    </svg>
                </button>
                <a th:href="@{/signin}" class="hidden sm:block text-sm font-medium text-slate-700 hover:text-indigo-600 transition-colors">Sign in</a>
                <a th:href="@{/signup}" class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-indigo-700 transition-colors">Create account</a>
            </div>
        </div>
    </div>

    <!-- Second line: Navigation Tabs and Dropdown -->
    <div class="px-4 sm:px-6 lg:px-8 border-t border-slate-200/80">
        <div class="flex items-center justify-between h-12">
            <!-- Left: Hub Tabs -->
            <nav class="flex -mb-px" aria-label="Hubs">
                <a th:each="hub : ${docsHubRegistry.getAllHubs()}"
                   th:href="@{/hub/{hubName}(hubName=${hub.hubName})}"
                   th:text="${hub.getArticleTree().title()}"
                   th:classappend="${activeTab == hub.hubName} ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                   class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors">
                </a>
            </nav>

            <!-- Right: API Dropdown -->
            <div x-data="{ open: false, isActive: /*[[${allApis.?[id == activeTab].size() > 0}]]*/ false }" class="relative">
                <button @click="open = !open" @click.away="open = false"
                        class="flex items-center gap-1 whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors"
                        :class="isActive ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'">
                    <span>APIs & SDKs</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 transition-transform" :class="{ 'rotate-180': open }">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div x-show="open" x-transition x-cloak class="absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <a th:each="api : ${allApis}"
                           th:href="@{/api(apiId=${api.id})}"
                           class="block px-4 py-2 text-sm"
                           th:classappend="${activeTab == api.id} ? 'bg-indigo-50 text-indigo-600' : 'text-slate-700 hover:bg-slate-100'"
                           role="menuitem" tabindex="-1"
                           th:text="${api.title}">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- ===================================================================================== -->
<!-- SEARCH MODAL FRAGMENT                                                                 -->
<!-- ===================================================================================== -->
<div th:fragment="search_modal"
     x-show="searchModalOpen"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     x-cloak
     class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-start justify-center pt-16 sm:pt-24">

    <div @click.away="closeSearchModal()"
         x-show="searchModalOpen"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col overflow-hidden">

        <!-- Search Input -->
        <div class="p-1 border-b relative">
            <svg class="w-5 h-5 text-slate-400 absolute top-1/2 left-5 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <input type="text"
                   x-ref="searchInput"
                   x-model="searchQuery"
                   placeholder="Search documentation..."
                   class="w-full border-0 bg-transparent py-3 pl-12 pr-4 text-base focus:ring-0">
        </div>

        <!-- Search Results -->
        <div class="max-h-[60vh] overflow-y-auto">
            <template x-if="isLoading">
                <div class="text-center text-slate-400 p-8">Loading search index...</div>
            </template>
            <template x-if="!isLoading && searchQuery && filteredResults.length === 0">
                <div class="text-center text-slate-500 p-8">
                    No results found for "<strong x-text="searchQuery"></strong>"
                </div>
            </template>
            <ul x-show="filteredResults.length > 0" class="divide-y divide-slate-100">
                <template x-for="(result, index) in filteredResults" :key="index">
                    <li>
                        <a :href="result.url" @click="closeSearchModal()" class="block p-4 hover:bg-indigo-50 transition-colors">
                            <div class="text-xs text-slate-500" x-html="result.breadcrumb"></div>
                            <h3 class="text-sm font-semibold text-slate-800" x-html="result.title"></h3>
                            <p x-show="result.snippet" class="text-xs text-slate-600 mt-1 truncate" x-html="result.snippet"></p>
                        </a>
                    </li>
                </template>
            </ul>
        </div>
    </div>
</div>

<!-- ===================================================================================== -->
<!-- SEARCH SCRIPT FRAGMENT                                                                -->
<!-- ===================================================================================== -->
<script th:fragment="search_script" th:inline="javascript">
    function searchController() {
        return {
            searchModalOpen: false,
            searchQuery: '',
            searchIndex: [],
            filteredResults: [],
            isLoading: false,
            isLoaded: false,
            openSearchModal() {
                this.searchModalOpen = true;
                this.$nextTick(() => this.$refs.searchInput.focus());
                if (!this.isLoaded) {
                    this.loadSearchIndex();
                }
            },
            closeSearchModal() {
                this.searchModalOpen = false;
                this.searchQuery = '';
                this.filteredResults = [];
            },
            loadSearchIndex() {
                this.isLoading = true;
                fetch('/search-index')
                    .then(response => response.json())
                    .then(data => {
                        this.searchIndex = data;
                        this.isLoaded = true;
                        console.log('Search index loaded:', this.searchIndex.length, 'items');
                    })
                    .catch(error => console.error('Error loading search index:', error))
                    .finally(() => this.isLoading = false);
            },
            /**
             * FIX: This function now searches the 'content' field and generates a snippet.
             */
            performSearch() {
                if (!this.searchQuery) {
                    this.filteredResults = [];
                    return;
                }
                const query = this.searchQuery.toLowerCase();
                this.filteredResults = this.searchIndex
                    .map(item => {
                        const titleMatch = item.title.toLowerCase().includes(query);
                        const breadcrumbMatch = item.breadcrumb.toLowerCase().includes(query);
                        const contentMatch = item.content && item.content.toLowerCase().includes(query);

                        if (titleMatch || breadcrumbMatch || contentMatch) {
                            const newItem = { ...item };
                            newItem.title = this.highlight(item.title, query);
                            newItem.breadcrumb = this.highlight(item.breadcrumb, query);

                            // If the match is in the content, create a contextual snippet.
                            if (contentMatch) {
                                newItem.snippet = this.createSnippet(item.content, query);
                            } else {
                                // Otherwise, just show the start of the content as a fallback.
                                newItem.snippet = item.content ? item.content.substring(0, 100) + '...' : '';
                            }
                            return newItem;
                        }
                        return null;
                    })
                    .filter(Boolean)
                    .slice(0, 15); // Show top 15 results
            },
            /**
             * NEW: Creates a contextual snippet from the content.
             */
            createSnippet(content, query) {
                const contentLower = content.toLowerCase();
                const queryLower = query.toLowerCase();
                const index = contentLower.indexOf(queryLower);

                if (index === -1) {
                    return content.substring(0, 100) + '...';
                }

                const start = Math.max(0, index - 40);
                const end = Math.min(content.length, index + query.length + 60);

                let snippet = content.substring(start, end);

                if (start > 0) snippet = '...' + snippet;
                if (end < content.length) snippet = snippet + '...';

                return this.highlight(snippet, query);
            },
            highlight(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${this.escapeRegex(query)})`, 'gi');
                return text.replace(regex, '<mark class="bg-transparent text-indigo-600 font-bold rounded-none p-0">$1</mark>');
            },
            escapeRegex(string) {
                return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            },
            init() {
                // Keyboard shortcut (Cmd+K or Ctrl+K)
                window.addEventListener('keydown', e => {
                    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
                        e.preventDefault();
                        this.openSearchModal();
                    }
                    if (e.key === 'Escape' && this.searchModalOpen) {
                        this.closeSearchModal();
                    }
                });
                // Watch for changes in searchQuery to perform search
                this.$watch('searchQuery', () => this.performSearch());
            }
        }
    }
</script>

<!-- ===================================================================================== -->
<!-- AI ASSISTANT PANEL (Push-style)                                                       -->
<!-- ===================================================================================== -->
<aside th:fragment="ai_assistant_panel"
       :class="aiPanelOpen ? 'w-full max-w-md border-l border-slate-200' : 'w-0'"
       class="flex-shrink-0 bg-white transition-all duration-300 ease-in-out overflow-hidden">

    <!-- This inner div ensures content doesn't get squeezed during the transition -->
    <div class="w-full max-w-md h-full flex flex-col">
        <!-- Header -->
        <header class="flex-shrink-0 border-b border-slate-200">
            <div class="h-16 flex items-center justify-between px-4">
                <h1 id="ai-assistant-title" class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                    <!-- Assistant Icon -->
                    <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="ai-gradient" x1="-2.24" y1="19.38" x2="20.15" y2="-3.02" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#55DDFF"></stop><stop offset="0.5" stop-color="#675DFF"></stop><stop offset="0.98" stop-color="#28239B"></stop>
                            </linearGradient>
                        </defs>
                        <path d="M11.4715 3.12411C11.5425 3.09893 11.5984 3.04302 11.6236 2.97196L12.2639 1.16504C12.3032 1.05404 12.4014 0.99854 12.4995 0.998535C12.5977 0.998531 12.6958 1.05403 12.7352 1.16504L13.3754 2.97196C13.4006 3.04302 13.4565 3.09893 13.5276 3.12411L15.3345 3.76436C15.4455 3.80369 15.501 3.90184 15.501 4C15.501 4.09816 15.4455 4.19631 15.3345 4.23565L13.5276 4.8759C13.4565 4.90108 13.4006 4.95698 13.3754 5.02805L12.7352 6.83497C12.6958 6.94597 12.5977 7.00147 12.4995 7.00147C12.4014 7.00147 12.3032 6.94596 12.2639 6.83497L11.6236 5.02805C11.5984 4.95698 11.5425 4.90108 11.4715 4.8759L9.66456 4.23565C9.55356 4.19632 9.49805 4.09816 9.49806 4C9.49806 3.90184 9.55356 3.80369 9.66456 3.76436L11.4715 3.12411Z" fill="url(#ai-gradient)"></path>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6.99952 5.99119L6.43977 7.57092C6.21315 8.21049 5.71001 8.71363 5.07044 8.94025L3.49071 9.5L5.07044 10.0598C5.71001 10.2864 6.21315 10.7895 6.43977 11.4291L6.99952 13.0088L7.55927 11.4291C7.78589 10.7895 8.28903 10.2864 8.9286 10.0598L10.5083 9.5L8.9286 8.94025C8.28903 8.71363 7.78589 8.21049 7.55927 7.57092L6.99952 5.99119ZM7.70645 3.49511C7.58846 3.1621 7.29398 2.99559 6.99951 2.9956C6.70505 2.9956 6.41058 3.1621 6.29259 3.49511L5.0259 7.06994C4.95036 7.28313 4.78265 7.45084 4.56946 7.52638L0.994626 8.79307C0.66162 8.91106 0.495117 9.20553 0.495117 9.5C0.495118 9.79447 0.661621 10.0889 0.994628 10.2069L4.56946 11.4736C4.78265 11.5492 4.95036 11.7169 5.0259 11.9301L6.29259 15.5049C6.41058 15.8379 6.70505 16.0044 6.99951 16.0044C7.29398 16.0044 7.58846 15.8379 7.70645 15.5049L8.97314 11.9301C9.04868 11.7169 9.21639 11.5492 9.42958 11.4736L13.0044 10.2069C13.3374 10.0889 13.5039 9.79447 13.5039 9.5C13.5039 9.20553 13.3374 8.91106 13.0044 8.79307L9.42958 7.52638C9.21639 7.45084 9.04868 7.28313 8.97314 7.06994L7.70645 3.49511Z" fill="url(#ai-gradient)"></path>
                    </svg>
                    <span>Assistant</span>
                </h1>
                <div class="flex items-center gap-2">
                    <!-- Action Buttons -->
                    <button class="p-2 rounded-md text-slate-500 hover:bg-slate-100 transition-colors" aria-label="Clear history">
                        <svg aria-hidden="true" width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9 3V1.5A1.5 1.5 0 0 0 7.5 0h-3A1.5 1.5 0 0 0 3 1.5V3H.75a.75.75 0 0 0 0 1.5h.75V10a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V4.5h.75a.75.75 0 0 0 0-1.5H9ZM7.5 1.4h-3a.1.1 0 0 0-.1.1V3h3.2V1.5a.1.1 0 0 0-.1-.1Zm1.6 3.1V10a.6.6 0 0 1-.6.6h-5a.6.6 0 0 1-.6-.6V4.5h6.2Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M4.625 5.5c.345 0 .625.28.625.625v2.75a.625.625 0 1 1-1.25 0v-2.75c0-.345.28-.625.625-.625Zm2.75 0c.345 0 .625.28.625.625v2.75a.625.625 0 1 1-1.25 0v-2.75c0-.345.28-.625.625-.625Z"></path></svg>
                    </button>
                    <button @click="aiPanelOpen = false" class="p-2 rounded-md text-slate-500 hover:bg-slate-100 transition-colors" aria-label="Close panel">
                        <svg aria-hidden="true" width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.249 1.249a.85.85 0 0 1 1.202 0L6 4.798l3.549-3.549a.85.85 0 1 1 1.202 1.202L7.202 6l3.549 3.549a.85.85 0 1 1-1.202 1.202L6 7.202l-3.549 3.549a.85.85 0 1 1-1.202-1.202L4.798 6l-3.55-3.549a.85.85 0 0 1 0-1.202Z"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content (Chat Area) -->
        <main class="flex-1 flex flex-col overflow-hidden p-4">
            <div class="flex-1 overflow-y-auto space-y-6">
                <!-- Welcome Message -->
                <div class="text-xs text-center text-slate-500">Responses are generated using AI and may contain mistakes.</div>

                <!-- Chat Bubbles -->
                <div class="space-y-4">
                    <div class="p-3 bg-slate-100 rounded-lg max-w-sm text-sm text-slate-700">
                        Ask questions about our documentation and get help with your integration.
                    </div>
                    <div class="p-3 bg-slate-100 rounded-lg max-w-sm text-sm text-slate-700">
                        Tip: you can highlight any text to ask questions about it.
                    </div>
                </div>

                <!-- Suggested Questions -->
                <div class="space-y-2">
                    <button class="w-full text-left p-3 bg-white border border-slate-200 rounded-lg text-sm text-slate-600 hover:bg-slate-50 transition-colors">What is noqodi?</button>
                    <button class="w-full text-left p-3 bg-white border border-slate-200 rounded-lg text-sm text-slate-600 hover:bg-slate-50 transition-colors">How do I get started?</button>
                    <button class="w-full text-left p-3 bg-white border border-slate-200 rounded-lg text-sm text-slate-600 hover:bg-slate-50 transition-colors">What are the different payment methods available?</button>
                </div>
            </div>
        </main>

        <!-- Footer (Input Area) -->
        <footer class="flex-shrink-0 p-4 border-t border-slate-200 bg-white">
            <div class="relative">
                <textarea rows="1" placeholder="Ask a question" class="w-full p-3 pr-12 border border-slate-300 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                <button disabled class="absolute right-2 top-2 p-2 rounded-full bg-indigo-500 text-white disabled:bg-slate-200 disabled:text-slate-400 transition-colors" aria-label="Send message">
                    <svg aria-hidden="true" width="16" height="16" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path d="M.97 4.72a.75.75 0 0 0 1.06 1.06l3.22-3.22v8.69a.75.75 0 0 0 1.5 0V2.56l3.22 3.22a.75.75 0 1 0 1.06-1.06L6.53.22a.748.748 0 0 0-1.06 0l-4.5 4.5Z"></path></svg>
                </button>
            </div>
        </footer>
    </div>
</aside>

<!-- ===================================================================================== -->
<!-- NEW FOOTER FRAGMENT                                                                   -->
<!-- ===================================================================================== -->
<footer th:fragment="footer_main" class="bg-slate-900 text-slate-400 flex-shrink-0">
    <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <p>&copy; <span th:text="${#dates.year(#dates.createNow())}">2024</span> noqodiDocs, Inc. All rights reserved.</p>
        </div>
    </div>
</footer>


<!-- ===================================================================================== -->
<!-- FRAGMENTS FOR OPENAPI SPECIFICATION PAGES (e.g., /docs)                               -->
<!-- ===================================================================================== -->

<!-- FRAGMENT: Sidebar Navigation Links -->
<div th:fragment="sidebar_nav_section">
    <!-- API Introduction Link -->
    <ul class="space-y-1">
        <li>
            <a href="#get-started" class="sidebar-link active">
                <span class="font-semibold">Introduction</span>
            </a>
        </li>
    </ul>

    <!-- API Operations -->
    <ul class="space-y-4 mt-6">
        <li th:each="group : ${groupedOperations}">
            <h3 class="sidebar-group-heading" th:text="${group.key}">Group Name</h3>
            <ul class="space-y-2">
                <li th:each="op : ${group.value}">
                    <a th:href="'#' + ${op.id}" class="sidebar-link">
                        <span th:text="${op.summary}">API Operation</span>
                    </a>
                </li>
            </ul>
        </li>
    </ul>
</div>

<!-- FRAGMENT: Main Content Panes (Middle + Right) -->
<div id="content-panes"
     class="flex flex-1 overflow-hidden"
     th:fragment="main_content_pane">

    <!-- Middle Pane -->
    <main id="main-content" class="w-7/12 p-12 overflow-y-auto">
        <!-- Introduction Section -->
        <section id="get-started" class="doc-section mb-24">
            <div class="prose text-sm max-w-none"
                 th:utext="${allDocs.get('get-started')}"></div>
        </section>
        <!-- API Operation Sections -->
        <div th:each="doc : ${allDocs}" th:if="${doc.key != 'get-started'}">
            <section th:id="${doc.key}" class="doc-section mb-24">
                <div class="prose text-sm max-w-none" th:utext="${doc.value}"></div>
            </section>
        </div>
    </main>

    <!-- Right Pane -->
    <aside class="w-5/12 bg-slate-50/50 border-l border-slate-200/80">
        <div class="sticky top-0 p-12 space-y-8 overflow-y-auto" style="max-height: 100vh;">
            <!-- Section 1: Code Snippet -->
            <div class="code-pane-bg rounded-xl shadow-lg overflow-hidden">
                <div class="code-block-header flex items-center justify-between px-5 py-3 border-b border-slate-700/50 flex-shrink-0">
                    <span class="text-sm font-medium text-slate-200">EXAMPLE REQUEST</span>
                    <div class="flex items-center gap-4">
                        <form id="snippet-form"
                              hx-get="/snippet"
                              hx-target="#snippet-container"
                              hx-swap="innerHTML"
                              hx-trigger="change from:#language-select, updateCodeSnippet from:body"
                              hx-include="[name='page'], [name='apiId']">
                            <div class="bg-black/20 rounded-md p-0.5 flex items-center">
                                <select id="language-select" name="lang" class="bg-transparent text-white text-sm border-0 focus:ring-0 appearance-none py-1 pl-2 pr-6">
                                    <option value="shell_curl">cURL</option>
                                    <option value="javascript_axios">Node.js</option>
                                    <option value="python_requests">Python</option>
                                    <option value="java_okhttp">Java</option>
                                    <option value="csharp_restsharp">C#</option>
                                    <option value="php_curl">PHP</option>
                                    <option value="go_native">Go</option>
                                    <option value="ruby_native">Ruby</option>
                                    <option value="swift_urlsession">Swift</option>
                                    <option value="kotlin_okhttp">Kotlin</option>
                                </select>
                            </div>
                        </form>
                        <a href="#" id="try-it-out-link"
                           class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors"
                           th:attr="data-operation-id=${currentPage}">Try it out &rarr;</a>
                    </div>
                </div>
                <div id="snippet-container" class="p-5 text-sm overflow-y-auto" style="max-height: 500px;">
                    <div th:replace="~{:: code_snippet_wrapper}"></div>
                </div>
            </div>

            <!-- Section 2: Dynamic Response Examples -->
            <div>
                <h3 class="text-base font-semibold text-slate-800 mb-3">Response Examples</h3>
                <div id="response-container"
                     hx-get="/responses"
                     hx-trigger="updateResponses from:body"
                     hx-swap="innerHTML"
                     hx-include="[name='page'], [name='apiId']">
                    <div th:replace="~{:: response_section}"></div>
                </div>
            </div>
        </div>
    </aside>
</div>

<!-- FRAGMENT: Code Snippet Wrapper -->
<div th:fragment="code_snippet_wrapper">
    <pre class="line-numbers !m-0 !p-0 !bg-transparent"><code th:class="'language-' + ${language}" th:utext="${snippet}"></code></pre>
</div>

<!-- FRAGMENT: Response Section -->
<div th:fragment="response_section">
    <div th:if="${!responses.isEmpty()}" x-data="{ openTab: 0 }" class="bg-white border border-slate-200/80 rounded-lg shadow-sm overflow-hidden">
        <!-- Tab Headers -->
        <div class="border-b border-slate-200/80">
            <div class="flex -mb-px px-2" aria-label="Tabs">
                <th:block th:each="response, iter : ${responses}">
                    <button th:x-on:click="|openTab = ${iter.index}|"
                            th:x-bind:class="|openTab === ${iter.index} ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'|"
                            class="whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-150">
                        <span th:text="${response.key}"
                              class="px-2 py-1 rounded-md text-xs font-mono"
                              th:classappend="${#strings.startsWith(response.key, '2')} ? 'bg-green-100 text-green-800' : (${#strings.startsWith(response.key, '4') or #strings.startsWith(response.key, '5')} ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800')">
                        </span>
                    </button>
                </th:block>
            </div>
        </div>
        <!-- Tab Content -->
        <div>
            <th:block th:each="response, iter : ${responses}">
                <div th:x-show="|openTab === ${iter.index}|" style="display: none;">
                    <div class="p-4">
                        <p class="text-sm text-slate-600 mb-3" th:text="${response.value.description()}"></p>
                    </div>
                    <div class="code-pane-bg">
                        <div class="p-5 text-sm overflow-y-auto">
                            <pre class="!m-0 !p-0 !bg-transparent"><code class="language-json" th:text="${response.value.exampleJson()}"></code></pre>
                        </div>
                    </div>
                </div>
            </th:block>
        </div>
    </div>
    <!-- Fallback content if there are no responses -->
    <div th:if="${responses.isEmpty()}" class="bg-white border border-slate-200/80 p-4 rounded-lg text-sm text-slate-400 shadow-sm">
        No response examples available for this endpoint.
    </div>
</div>


<!-- ===================================================================================== -->
<!-- FRAGMENTS FOR MARKDOWN DOCUMENTATION HUB PAGES (e.g., /hub/*)                         -->
<!-- ===================================================================================== -->
<li th:fragment="menu-node(node, hubName, hub)"
    th:attr="x-data=|{
        expanded: false,
        nodeId: '${node.id}',
        isSection: ${node.isSection()},
        descendantIds: ${node.isSection() ? hub.getDescendantArticleIds(node.id) : '[]'}
    }|">

    <div class="flex items-center justify-between p-1 rounded-md"
         :class="{ 'bg-indigo-50': activeArticleId === nodeId && !isSection }">

        <div class="flex items-center flex-1 min-w-0">
            <!-- Expander -->
            <button @click="expanded = !expanded" th:if="${node.isSection()}" class="mr-1 text-slate-400">
                <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-90': expanded }" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
            <!-- Icon -->
            <svg th:if="${node.isSection()}" class="w-4 h-4 text-slate-400 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
            <svg th:unless="${node.isSection()}" class="w-4 h-4 text-slate-400 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>

            <!-- Title Link -->
            <a th:if="${!node.isSection()}" href="#"
               class="text-sm truncate flex-1"
               :class="{ 'font-semibold text-indigo-600': activeArticleId === nodeId, 'text-slate-700': activeArticleId !== nodeId }"
               @click.prevent="activeArticleId = nodeId"
               th:hx-get="@{/hub/{hubName}/article/{id}(hubName=${hubName}, id=${node.id})}"
               hx-target="#docs-article-content"
               hx-swap="innerHTML"
               hx-trigger="click">
                <span th:text="${node.title()}">Article Title</span>
            </a>
            <span th:if="${node.isSection()}" class="text-sm font-medium text-slate-800" th:text="${node.title()}">Section Title</span>
        </div>
    </div>

    <!-- Child Nodes: This list automatically expands if the active article is one of its descendants. -->
    <ul th:if="${node.isSection()}"
        x-show="expanded"
        x-collapse
        class="ml-4 pl-4 border-l border-slate-200 space-y-1 mt-1"
        x-init="$watch('activeArticleId', newId => { if (descendantIds.includes(newId)) { expanded = true } })">
        <th:block th:each="child : ${node.children()}">
            <li th:replace="~{:: menu-node(node=${child}, hubName=${hubName}, hub=${hub})}"></li>
        </th:block>
    </ul>
</li>

<!-- FRAGMENT: The main article content area -->
<div th:fragment="article-content">
    <!-- Display content ONLY if an article was found and passed to the model -->
    <div th:if="${article != null}"
         class="prose max-w-none"
         th:hx-get="@{/hub/{hubName}/toc/{id}(hubName=${hub.hubName}, id=${article.id})}"
         hx-target="#docs-article-toc"
         hx-trigger="load"
         hx-swap="innerHTML">

        <div th:utext="${renderedContent}"></div>

        <!-- Next/Previous Navigation -->
        <div th:if="${navigation}" th:with="prev=${navigation.children().get(0)}, next=${navigation.children().get(1)}"
             class="mt-12 flex justify-between border-t border-slate-200 pt-6 not-prose">
            <div>
                <a th:if="${prev.id()}" th:href="'#' + ${prev.id()}"
                   th:attr="x-on:click.prevent=|activeArticleId = '${prev.id}'|"
                   th:hx-get="@{/hub/{hubName}/article/{id}(hubName=${hub.hubName}, id=${prev.id})}"
                   hx-target="#docs-article-content"
                   class="inline-flex items-center text-slate-600 hover:text-indigo-600 transition-colors">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    <div>
                        <div class="text-xs text-slate-500">Previous</div>
                        <div class="text-sm font-semibold" th:text="${prev.title()}"></div>
                    </div>
                </a>
            </div>
            <div>
                <a th:if="${next.id()}" th:href="'#' + ${next.id()}"
                   th:attr="x-on:click.prevent=|activeArticleId = '${next.id}'|"
                   th:hx-get="@{/hub/{hubName}/article/{id}(hubName=${hub.hubName}, id=${next.id})}"
                   hx-target="#docs-article-content"
                   class="inline-flex items-center text-slate-600 hover:text-indigo-600 transition-colors text-right">
                    <div>
                        <div class="text-xs text-slate-500">Next</div>
                        <div class="text-sm font-semibold" th:text="${next.title()}"></div>
                    </div>
                    <svg class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                </a>
            </div>
        </div>
    </div>

    <!-- Display a "not found" message if no article was found in the model -->
    <div th:if="${article == null}" class="prose max-w-none">
        <h1 class="text-red-500">Article Not Found</h1>
        <p>The requested article could not be found in this documentation hub.</p>
        <p>Please select a valid article from the menu.</p>
    </div>
</div>

<!-- FRAGMENT: A generic error display -->
<div th:fragment="error-content" class="prose max-w-none">
    <h1 class="text-red-500">Error</h1>
    <p th:text="${error ?: 'An unexpected error occurred.'}">Error message goes here.</p>
</div>

<!-- FRAGMENT: The "On this page" table of contents -->
<div th:fragment="table-of-contents" class="sticky top-24">
    <h3 class="text-sm font-semibold text-slate-900 tracking-tight">On this page</h3>
    <ul th:if="${!toc.isEmpty()}" class="mt-4 space-y-2 text-sm">
        <li th:each="item : ${toc}">
            <a th:href="'#' + ${item.anchor}"
               class="block text-slate-500 hover:text-slate-800"
               th:classappend="${item.level == '3'} ? 'pl-4'">
                <span th:text="${item.title}"></span>
            </a>
        </li>
    </ul>
    <p th:if="${toc.isEmpty()}" class="mt-4 text-sm text-slate-500">No subheadings found in this article.</p>
</div>

</body>
</html>