<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:x-on="http://www.w3.org/1999/xhtml" xmlns:x-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Documentation</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet"/>
    <style>
        html { scroll-behavior: smooth; }
        .line-numbers .line-numbers-rows { border-right-color: #334155 !important; }
        div.code-toolbar > .toolbar .toolbar-item > button {
            background: #4a5568; color: #e2e8f0; border-radius: 0.375rem;
            padding: 0.25rem 0.75rem; font-size: 0.875rem; box-shadow: none; border: none;
        }
        div.code-toolbar > .toolbar .toolbar-item > button:hover { background: #2d3748; }
        .prose pre { all: unset; }
        .prose pre code { all: unset; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="text-slate-800" x-data="docsApp()">

<div class="flex h-screen">
    <!-- Left Pane: Sidebar -->
    <aside id="sidebar"
           class="flex-shrink-0 bg-white border-r border-slate-200/80 flex flex-col transition-all duration-300"
           :class="isSidebarCollapsed ? 'w-20' : 'w-72'">

        <!-- 1. Sticky Header -->
        <div class="p-6 pb-4 border-b border-slate-200 flex-shrink-0">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-xl font-bold text-slate-900" :class="isSidebarCollapsed ? 'hidden' : 'block'">
                    <a href="/docs" class="hover:text-indigo-600 transition-colors">API Docs</a>
                </h1>
                <button @click="isSidebarCollapsed = !isSidebarCollapsed" class="flex-shrink-0 flex items-center justify-center h-9 w-9 text-slate-500 hover:bg-slate-100 hover:text-slate-800 rounded-md transition-colors">
                    <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 transition-transform duration-300" :class="isSidebarCollapsed ? 'rotate-180' : ''">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.75 19.5l-7.5-7.5 7.5-7.5m-6 15L5.25 12l7.5-7.5" />
                    </svg>
                </button>
            </div>
            <button id="search-trigger" class="relative text-left w-full bg-slate-100 border-transparent rounded-md py-2 pl-9 pr-3 text-sm text-slate-500 hover:bg-slate-200 transition" :class="isSidebarCollapsed ? 'hidden' : 'block'">
                <svg class="w-4 h-4 text-slate-400 absolute top-1/2 left-3 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <span>Find Anything...</span>
            </button>
        </div>

        <!-- 2. Scrollable Navigation -->
        <div class="flex-1 overflow-y-auto p-6">
            <nav>
                <ul class="space-y-1">
                    <li>
                        <a href="#get-started" class="sidebar-link active">
                            <span class="font-semibold" :class="isSidebarCollapsed ? 'hidden' : 'block'">Introduction</span>
                        </a>
                    </li>
                    <th:block th:each="api : ${availableApis}">
                        <li x-data="{ open: openApiAccordion === '[[${api.key}]]' }">
                            <div class="flex items-center justify-between rounded-md" :class="{ 'bg-slate-100': open }">
                                <button @click="open = !open; openApiAccordion = open ? '[[${api.key}]]' : ''"
                                        class="flex items-center w-full text-left p-2 font-semibold text-slate-800">
                                    <span :class="isSidebarCollapsed ? 'hidden' : 'block'" th:text="${api.key}"></span>
                                </button>
                                <div class="relative pr-2" :class="isSidebarCollapsed ? 'hidden' : 'block'">
                                    <select name="version"
                                            class="text-xs text-slate-500 bg-white border border-slate-300 rounded-md py-1 pl-2 pr-7 focus:ring-indigo-500 focus:border-indigo-500"
                                            th:data-api-title="${api.key}"
                                            @change="activeApiTitle = $el.dataset.apiTitle; activeApiVersion = $event.target.value; htmx.trigger('body', 'versionChanged')">
                                        <option th:each="version : ${api.value}"
                                                th:value="${version}"
                                                th:text="'v' + ${version}"
                                                th:selected="${api.key == defaultApiTitle and version == defaultApiVersion}"></option>
                                    </select>
                                </div>
                            </div>
                            <div x-show="open" x-cloak
                                 class="pl-2 pt-2"
                                 :class="isSidebarCollapsed ? 'hidden' : 'block'"
                                 th:id="'nav-container-' + ${api.key}"
                                 hx-get="/sidebar-nav"
                                 th:hx-vals="|'title':'${api.key}', 'version':activeApiVersion|"
                                 hx-trigger="load, versionChanged from body"
                                 hx-swap="innerHTML">
                                <div th:if="${api.key == defaultApiTitle}" th:replace="~{fragments :: sidebar_nav_section}"></div>
                            </div>
                        </li>
                    </th:block>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div id="main-content-wrapper" class="flex flex-1 flex-col">
        <header class="h-16 bg-white border-b border-slate-200 flex-shrink-0 flex items-center px-8">
            <div class="text-slate-600 font-medium">
                API Reference
            </div>
        </header>
        <div id="content-panes"
             class="flex flex-1 overflow-hidden"
             th:replace="~{fragments :: main_content_pane}">
        </div>
    </div>
</div>

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 sm:p-6 md:p-12 transition-opacity duration-300 opacity-0">
    <div id="search-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col overflow-hidden transform scale-95 transition-all duration-300">
        <div class="p-4 border-b relative">
            <svg class="w-5 h-5 text-slate-400 absolute top-1/2 left-7 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <input type="text" id="search-modal-input" placeholder="Search documentation..." class="w-full border-0 bg-transparent py-2 pl-10 pr-4 text-base focus:ring-0">
        </div>
        <div id="search-results-container" class="max-h-[60vh] overflow-y-auto p-2">
            <div class="text-center text-slate-400 p-8">Start typing to see results.</div>
        </div>
    </div>
</div>

<!-- API Tester Modal (for RapiDoc) -->
<div id="api-tester-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4 sm:p-6 md:p-12 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl w-full h-full flex flex-col overflow-hidden">
        <div class="p-4 border-b flex justify-between items-center flex-shrink-0 bg-slate-50">
            <h3 class="font-bold text-lg text-slate-800">Interactive API Tester</h3>
            <button id="modal-close-btn" class="text-3xl font-light text-slate-500 hover:text-slate-800 transition-colors">&times;</button>
        </div>
        <div class="flex-1 overflow-hidden">
            <iframe id="api-tester-iframe" class="w-full h-full border-0"></iframe>
        </div>
    </div>
</div>

<!-- Hidden inputs to hold the current state for HTMX requests -->
<input type="hidden" id="current-page-input" name="page" th:value="${currentPage}" />
<input type="hidden" id="active-api-title" name="apiTitle" x-model="activeApiTitle">
<input type="hidden" id="active-api-version" name="apiVersion" x-model="activeApiVersion">

<!-- Prism.js JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

<script th:inline="javascript">
    function docsApp() {
        return {
            isSidebarCollapsed: false,
            activeApiTitle: /*[[${defaultApiTitle}]]*/ 'Default API',
            activeApiVersion: /*[[${defaultApiVersion}]]*/ '1.0',
            openApiAccordion: /*[[${defaultApiTitle}]]*/ 'Default API'
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        const pageInput = document.getElementById('current-page-input');
        let scrollObserver;

        const searchTrigger = document.getElementById('search-trigger');
        const searchModal = document.getElementById('search-modal');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchInput = document.getElementById('search-modal-input');
        const searchResultsContainer = document.getElementById('search-results-container');

        const apiTesterModal = document.getElementById('api-tester-modal');
        const apiTesterIframe = document.getElementById('api-tester-iframe');
        const closeApiTesterModalBtn = document.getElementById('modal-close-btn');

        let searchableIndex = [];

        const escapeRegex = (string) => string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');

        function buildSearchIndex() {
            searchableIndex = [];
            document.querySelectorAll('.doc-section').forEach(section => {
                const id = section.id;
                const titleElement = section.querySelector('h1, h2, h3, h4');
                const title = titleElement ? titleElement.textContent.trim() : 'Untitled Section';
                const originalContent = section.textContent;
                const lowerCaseContent = originalContent.toLowerCase();
                searchableIndex.push({ id, title, originalContent, lowerCaseContent });
            });
        }

        const openSearchModal = () => {
            searchModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                searchModal.classList.add('opacity-100');
                searchModalContent.classList.add('scale-100');
                searchModalContent.classList.remove('scale-95');
                searchInput.focus();
            }, 10);
        };

        const closeSearchModal = () => {
            searchModal.classList.remove('opacity-100');
            searchModalContent.classList.remove('scale-100');
            searchModalContent.classList.add('scale-95');
            setTimeout(() => {
                searchModal.classList.add('hidden');
                document.body.style.overflow = '';
                searchInput.value = '';
                searchResultsContainer.innerHTML = '<div class="text-center text-slate-400 p-8">Start typing to see results.</div>';
            }, 300);
        };

        const performSearch = (query) => {
            if (!query) {
                searchResultsContainer.innerHTML = '<div class="text-center text-slate-400 p-8">Start typing to see results.</div>';
                return;
            }
            const lowerCaseQuery = query.toLowerCase();
            const results = searchableIndex.filter(item =>
                item.title.toLowerCase().includes(lowerCaseQuery) || item.lowerCaseContent.includes(lowerCaseQuery)
            );

            if (results.length === 0) {
                searchResultsContainer.innerHTML = `<div class="text-center text-slate-400 p-8">No results found for "<strong>${query}</strong>".</div>`;
                return;
            }

            const highlightRegex = new RegExp(escapeRegex(query), 'gi');
            searchResultsContainer.innerHTML = results.map(result => {
                const matchIndex = result.lowerCaseContent.indexOf(lowerCaseQuery);
                const snippetRadius = 45;
                const snippetStart = Math.max(0, matchIndex - snippetRadius);
                const snippetEnd = Math.min(result.originalContent.length, matchIndex + lowerCaseQuery.length + snippetRadius);
                let snippet = result.originalContent.substring(snippetStart, snippetEnd).trim();
                if (snippetStart > 0) snippet = '...' + snippet;
                if (snippetEnd < result.originalContent.length) snippet = snippet + '...';
                const highlightedSnippet = snippet.replace(highlightRegex, '<strong class="text-indigo-600 font-semibold bg-indigo-100/50 rounded-sm">$&</strong>');
                return `
                    <a href="#${result.id}" class="search-result-item block p-4 rounded-lg hover:bg-slate-100 cursor-pointer" data-target-id="${result.id}">
                        <div class="font-semibold text-slate-800">${result.title}</div>
                        <div class="text-sm text-slate-600 mt-1 leading-relaxed">${highlightedSnippet}</div>
                    </a>
                `;
            }).join('');
        };

        function setupScrollObserver() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            if (scrollObserver) scrollObserver.disconnect();

            const sections = mainContent.querySelectorAll('.doc-section');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const tryItOutLink = document.getElementById('try-it-out-link');

            const observerOptions = { root: mainContent, rootMargin: "-40% 0px -60% 0px", threshold: 0 };

            scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const sectionId = entry.target.id;
                        sidebarLinks.forEach(link => link.classList.toggle('active', link.href.endsWith('#' + sectionId)));
                        pageInput.value = sectionId;
                        if (tryItOutLink) tryItOutLink.setAttribute('data-operation-id', sectionId);
                        htmx.trigger('body', 'updateCodeSnippet');
                        htmx.trigger('body', 'updateResponses');
                    }
                });
            }, observerOptions);

            sections.forEach(section => scrollObserver.observe(section));
        }

        document.body.addEventListener('htmx:afterOnLoad', function(event) {
            Prism.highlightAll();
            if (window.Alpine) Alpine.initTree(event.target);

            if (event.target.id === 'content-panes') {
                setupScrollObserver();
                buildSearchIndex();
                document.getElementById('main-content').scrollTop = 0;
            }
        });

        searchTrigger.addEventListener('click', openSearchModal);
        searchModal.addEventListener('click', (e) => { if (e.target === searchModal) closeSearchModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSearchModal(); });
        searchInput.addEventListener('input', (e) => performSearch(e.target.value));
        searchResultsContainer.addEventListener('click', (e) => {
            const resultItem = e.target.closest('.search-result-item');
            if (resultItem) {
                e.preventDefault();
                const targetElement = document.getElementById(resultItem.dataset.targetId);
                if (targetElement) {
                    closeSearchModal();
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });

        const closeApiTesterModal = () => {
            apiTesterModal.classList.add('hidden');
            apiTesterModal.classList.remove('flex');
            apiTesterIframe.src = 'about:blank';
        };

        document.body.addEventListener('click', function (event) {
            if (event.target.id === 'try-it-out-link') {
                event.preventDefault();
                const operationId = event.target.dataset.operationId;

                const activeTitle = document.getElementById('active-api-title').value;
                const activeVersion = document.getElementById('active-api-version').value;

                if (operationId && operationId !== 'get-started') {
                    const title = encodeURIComponent(activeTitle);
                    const version = encodeURIComponent(activeVersion);
                    const op = encodeURIComponent(operationId);

                    // Point the iframe to the RapiDoc tester endpoint
                    apiTesterIframe.src = `/rapidoc-tester?title=${title}&version=${version}&operation=${op}`;

                    apiTesterModal.classList.remove('hidden');
                    apiTesterModal.classList.add('flex');
                }
            }
        });

        closeApiTesterModalBtn.addEventListener('click', closeApiTesterModal);
        apiTesterModal.addEventListener('click', (e) => { if (e.target === apiTesterModal) closeApiTesterModal(); });

        setupScrollObserver();
        buildSearchIndex();
    });
</script>

</body>
</html>